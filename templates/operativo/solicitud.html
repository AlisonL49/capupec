{% extends 'navbar.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">
    <!-- Encabezado -->
    <div class="card ">
        <div class="card-custom-header  d-flex">
            <h5 class="mb-0">Solicitud de Crédito</h5>
        </div>

        <div class="card-body">
            <!-- Mensajes de error -->
            {% if messages %}
            <div>
                {% for message in messages %}
                <div
                    class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'warning' %}alert-warning{% else %}alert-success{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="border rounded p-3 mb-3">
                <div class="pb-3">
                    <!-- formulario de búsqueda -->
                    <label for="buscar" class="form-label">Buscar Socio</label>
                    {% include 'partials/formulario_busqueda.html' %}
                </div>
                <!-- Tabla de Búsqueda -->
                <div class="table-responsive mb-3">
                    <table class="table table-bordered rounded table-hover text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>NOMBRES</th>
                                <th>IDENTIFICACIÓN</th>
                                <th>NO. SOCIO</th>
                                <th>ACCIÓN</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if search_query %}
                            {% for usuario in usuarios %}
                            <tr class="fila-socio" data-usuario-id="{{ usuario.id }}" style="cursor: pointer;">
                                <td>{{ usuario.user.last_name }} {{ usuario.user.first_name }}</td>
                                <td>{{ usuario.cedula }}</td>
                                <td>{{ usuario.id }}</td>
                                <td><a href="?seleccionar={{ usuario.id }}">Seleccionar</a></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3">
                                    {% if search_query %}
                                    No se encontraron socios con "{{ search_query }}"
                                    {% else %}
                                    No hay socios registrados
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td>null</td>
                                <td>null</td>
                                <td>null</td>
                                <td>null</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <form id="form-solicitud-credito" method="post">
                {% csrf_token %}
                <input type="hidden" name="accion" value="" id="accion">
                <div class="border rounded p-3 mb-3">
                    <!-- Datos Generales -->
                    <div class="row mb-3">

                        <div class="col-md-2">
                            <label for="nroSocio" class="form-label">No. Socio</label>
                            <input type="text" class="form-control" id="nroSocio" name="sol_socio"
                                value="{% if socio_seleccionado %}{{ socio_seleccionado.id }}{% endif %}"
                                placeholder=" " readonly>
                        </div>
                        <div class="col-md-2">
                            <label for="nro_solicitud" class="form-label">Nro. Solicitud</label>
                            <input type="text" id="nro_solicitud" name="sol_nro_solicitud" class="form-control"
                                value="{{valores_ingresados.nro_solicitud}}">
                        </div>
                    </div>


                    <!-- Datos del Garante -->
                    <div class="row mb-3 align-items-end">
                        <div class="col-md-1">
                            <label for="garante" class="form-label">Garante</label>
                            <input class="form-check-input" type="checkbox" id="garante_checkbox" name="sol_garante">
                        </div>
                        <div class="col-md-6">
                            <label for="nombre_garante" class="form-label">Nombres Garante</label>
                            <input type="text" id="nombre_garante" class="form-control autocomplete-garante" disabled>
                        </div>
                        <div class="col-md-2">
                            <label for="num_garante" class="form-label">Nro. Garante</label>
                            <input type="text" id="num_garante" name="sol_nro_garante" class="form-control" disabled>
                        </div>
                        <div class="col-md-3">
                            <label for="s_creditos" class="form-label">S. Créditos</label>
                            <input type="text" id="s_creditos" name="sol_s_creditos" class="form-control" disabled>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <!-- Tipo de Crédito -->
                        <div class="col-md-4">
                            <label for="tipo_credito" class="form-label">Tipo Crédito</label>
                            <select id="tipo_credito" name="sol_tipo_credito" class="form-select">
                                <option value="">Seleccione ...</option>
                                {% for credito in tipos_credito %}
                                <option value="{{ credito.id }}">
                                    {{ credito.tcredito_tipo }}
                                </option>
                                {% endfor %}
                            </select>

                        </div>

                        <!-- Forma de Pago -->
                        <div class="col-md-3">
                            <label for="forma_pago" class="form-label">Forma de Pago</label>
                            <select id="forma_pago" name="sol_forma_pago" class="form-select">
                                <option value="">Seleccione ...</option>
                                {% for pago in formas_pago %}
                                <option value="{{ pago.id }}">
                                    {{ pago.fpago_descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Interés -->
                        <div class="col-md-2">
                            <label for="interes" class="form-label">T. Interés</label>
                            <input type="number" id="interes" name="sol_interes" class="form-control" disabled >
                        </div>

                        <!-- Gracia -->
                        <div class="col-md-1">
                            <label for="gracia" class="form-label">Gracia</label>
                            <input type="number" id="gracia"  class="form-control" disabled
                                value="{{ valores_ingresados.gracia }}" readonly>
                        </div>
                        <!-- Gracia -->
                        <div class="col-md-2">
                            <label for="min_aporte" class="form-label">Aportes minimo </label>
                            <input type="number" id="min_aporte"  class="form-control" disabled
                                value="{{ valores_ingresados.min_aporte }}" readonly>
                        </div>
                    </div>



                    <!-- Monto, Cuotas, Destino -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="monto" class="form-label">Monto</label>
                            <input type="text" id="monto" name="sol_monto" class="form-control"
                                value="{{ valores_ingresados.monto }}">
                        </div>
                        <div class="col-md-3">
                            <label for="cuotas" class="form-label">Cuotas</label>
                            <input type="number" id="cuotas" name="sol_cuotas" class="form-control"
                                value="{{ valores_ingresados.cuotas }}">
                        </div>
                        <div class="col-md-3">
                            <label for="tipo_tabla" class="form-label">Tipo Tabla</label>
                            <select id="tipo_tabla" name="sol_tipo_tabla" class="form-select">
                                <option value="FRANCESA">FRANCESA</option>
                                <!--<option value="ALEMAN" {% if valores_ingresados.tipo_tabla == "ALEMAN" %}selected{% endif %}>ALEMAN</option>-->
                            </select>

                        </div>
                    </div>

                    <!-- Aportes y Condición -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="aportes" class="form-label">No. Aportes</label>
                            <input type="text" id="aportes" class="form-control" value="{{ valores_ingresados.nro_aportes }}"
                                disabled readonly >

                        </div>
                        <div class="col-md-3">
                            <label for="v_aportes" class="form-label">V. Aportes</label>
                            <input type="text" id="v_aportes" name="sol_nro_aportes" class="form-control"
                                value="{{ valores_ingresados.valor_aportes }}" disabled readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="condicion" class="form-label">Condición Laboral</label>
                            <input type="text" id="condicion" name="sol_condicion" value="{{ valores_ingresados.condicion}}" class="form-control" disabled readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="disponible" class="form-label">Disponible</label>
                            <input type="text" id="disponible" name="sol_disponible" class="form-control"
                                value="{{ valores_ingresados.disponible }}" disabled readonly>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" id="btn-calcular" class="btn btn-warning">Calcular</button>

                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="reset" class="btn btn-secondary">Limpiar</button>
                    </div>

                    <!-- Valores de Crédito -->
                    <div class="row mb-3 mt-4">
                        <div class="col-md-2">
                            <label for="v_solicitud" class="form-label">V.Solicitud</label>
                            <input type="text" id="v_solicitud" class="form-control" value="{{ v_solicitud }}" readonly>
                        </div>
                        <div class="col-md-2">
                            <label for="comision" class="form-label">Comisión</label>
                            <input type="text" id="comision" class="form-control" value="{{ comision }}" readonly>
                        </div>
                        <div class="col-md-2">
                            <label for="v_encaje" class="form-label">V.Encaje</label>
                            <input type="text" id="v_encaje" class="form-control" value="{{ v_encaje }}" readonly>
                        </div>
                        <div class="col-md-2">
                            <label for="monto_total" class="form-label">Monto Total</label>
                            <input type="text" id="monto_total" class="form-control" value="{{ monto_total }}" readonly>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">


                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="fas fa-print"></i> Imprimir
                            </button>

                            <button type="button" id="btn-imprimir" class="btn btn-outline-primary w-100"
                                data-socio-id="{{ socio_seleccionado.id|default:'' }}">
                                <i class="fas fa-print"></i> Imprimir
                            </button>





                        </div>

                    </div>

                    <!-- Tabla de Amortización Francesa -->
                    <div class="table-responsive mb-3">
                        <table class="table table-bordered table-striped text-center">
                            <thead class="table-dark">
                                <tr>
                                    <th>N°</th>
                                    <th>Fecha de Pago</th>
                                    <th>Capital</th>
                                    <th>Interés</th>
                                    <th>Seguro</th>
                                    <th>Cuota Total</th>
                                    <th>Saldo Pendiente</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cuota in tabla_amortizacion %}
                                <tr>
                                    <td>{{ cuota.numero }}</td>
                                    <td>{{ cuota.fecha_pago }}</td>
                                    <td>{{ cuota.capital }}</td>
                                    <td>{{ cuota.interes }}</td>
                                    <td>{{ cuota.seguro }}</td>
                                    <td>{{ cuota.cuota_total }}</td>
                                    <td>{{ cuota.saldo }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="{% static 'js/autocomplete.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkbox = document.getElementById("garante_checkbox");
        const fields = [
            document.getElementById("nombre_garante"),
            document.getElementById("num_garante"),
            document.getElementById("s_creditos")
        ];
        checkbox.addEventListener("change", function () {
            fields.forEach(field => field.disabled = !checkbox.checked);
        });

        inicializarAutocompleteConId("#nombre_garante", "{% url 'buscar_usuarios' %}", "#num_garante");
    });
</script>
<script src="{% static 'js/scripts.js' %}"></script>

{% endblock %}